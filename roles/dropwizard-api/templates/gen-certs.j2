keystore="/apis/keytool_files/{{ key_alias }}.keystore"
truststore="/apis/keytool_files/{{ key_alias }}.truststore"

GenerateKey () {
	keytool \
		-genkeypair \
		-dname "{{ key_dname }}" \
		-ext "{{ key_ext }}" \
		-alias {{ key_alias }} \
		-keyalg {{ key_alg }} \
		-keysize {{ key_size }} \
		-sigalg {{ sig_alg }} \
		-validity {{ key_validity }} \
		-storepass {{ store_psd }} \
		-keypass {{ key_psd }} \
		-keystore $1
}

ImportCert () {
	keytool \
	-exportcert \
	-rfc \
	-alias {{ key_alias }} \
	-keystore $1 \
	-storepass {{ store_psd }} \
	-keypass {{ key_psd }} \
	-file /apis/{{ key_alias }}.pem

	keytool \
		-importcert \
		-alias {{ key_alias }} \
		-file /apis/{{ key_alias }}.pem \
		-storepass {{ store_psd }} \
		-keypass {{ key_psd }} \
		-noprompt \
		-keystore $2
	
	# clean up pem file
	rm /apis/{{ key_alias }}.pem
}

# Keystore
if [ -f $keystore ]; then
	echo "$keystore already exists!"

	alias_exist=$(keytool -list -v -keystore $keystore -storepass {{ store_psd }} | grep {{ key_alias }})
	if [ $? -eq 0 ]; then
		echo "Keystore: {{ key_alias }} already exists! Renewing {{ key_alias }} ..."
		keytool \
			-delete \
			-alias {{ key_alias }} \
			-keystore $keystore \
			-storepass {{ store_psd }}
		GenerateKey $keystore
		keytool -list -v -keystore $keystore -storepass {{ store_psd }} | grep "Valid"
	else
		echo "Keystore: {{ key_alias }} does not exist! Adding {{ key_alias }} ..." 
		GenerateKey $keystore
		keytool -list -v -keystore $keystore -storepass {{ store_psd }} | grep "Valid"
	fi

else
	echo "Keystore: $keystore does not exist! Gnerating $keystore ..."
	GenerateKey "/apis/{{ key_alias }}.keystore"
fi

# Truststore
if [ -f $truststore ]; then
	echo "$truststore already exists!"

	alias_exist=$(keytool -list -v -keystore $truststore -storepass {{ store_psd }} | grep {{ key_alias }})
	if [ $? -eq 0 ]; then
		echo "Truststore: {{ key_alias }} already exists! Renewing {{ key_alias }} ..."
		keytool \
			-delete \
			-alias {{ key_alias }} \
			-keystore $truststore \
			-storepass {{ store_psd }}
		ImportCert $keystore $truststore
		keytool -list -v -keystore $truststore -storepass {{ store_psd }} | grep "Valid"
	else
		echo "Truststore: {{ key_alias }} does not exist! Adding {{ key_alias }} ..." 
		ImportCert $keystore $truststore
		keytool -list -v -keystore $truststore -storepass {{ store_psd }} | grep "Valid"
	fi

else
	echo "Truststore: $truststore does not exist! Gnerating $truststore ..."
	ImportCert "/apis/{{ key_alias }}.keystore" "/apis/{{ key_alias }}.truststore"
fi